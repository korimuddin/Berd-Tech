<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Edit / Fill &amp; Sign (Client-side)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-elevated: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.1);
      --border-subtle: #1f2937;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 50%, #000 100%);
      color: var(--text);
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px;
      gap: 12px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
      box-shadow: 0 0 0 1px rgba(148,163,184,0.15), 0 20px 40px rgba(15,23,42,0.7);
      backdrop-filter: blur(20px);
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 40%, #0369a1 80%);
      box-shadow: 0 0 20px rgba(56,189,248,0.7);
      position: relative;
    }

    .logo-mark::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: inherit;
      border: 2px solid rgba(15,23,42,0.9);
    }

    .logo-text-main {
      font-weight: 600;
      letter-spacing: 0.02em;
      font-size: 14px;
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,118,110,0.28);
      border: 1px solid rgba(45,212,191,0.3);
      color: #a5f3fc;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(240px, 0.7fr);
      gap: 12px;
      height: calc(100vh - 80px);
      max-height: 900px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
        grid-auto-rows: auto;
        height: auto;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
      border-radius: 18px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 0 1px rgba(30,64,175,0.35), 0 18px 35px rgba(15,23,42,0.85);
      position: relative;
      overflow: hidden;
      min-height: 0;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), transparent 60%);
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      z-index: 1;
    }

    .panel-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-soft);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      z-index: 1;
    }

    .group {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.15);
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 5px 10px;
      background: transparent;
      color: var(--text-soft);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: background 0.16s ease, color 0.16s ease, box-shadow 0.16s ease, transform 0.1s ease;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.35;
      cursor: default;
    }

    .btn:hover:not(:disabled) {
      background: rgba(30,64,175,0.6);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(129,140,248,0.4);
      transform: translateY(-0.5px);
    }

    .btn.primary {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: #0b1120;
      font-weight: 500;
      box-shadow: 0 0 0 1px rgba(8,47,73,0.5), 0 10px 25px rgba(15,23,42,0.9);
    }

    .btn.primary:hover:not(:disabled) {
      background: radial-gradient(circle at top left, #67e8f9, #22d3ee);
      box-shadow: 0 0 0 1px rgba(8,47,73,0.6), 0 16px 30px rgba(8,47,73,0.9);
    }

    .btn.icon {
      padding-inline: 8px;
      font-size: 13px;
    }

    .btn.active {
      background: rgba(56,189,248,0.12);
      color: #e0f2fe;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
    }

    input[type="file"] {
      font-size: 11px;
      color: var(--text-soft);
    }

    input[type="range"] {
      appearance: none;
      width: 90px;
      height: 4px;
      border-radius: 999px;
      background: rgba(31,41,55,0.9);
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56,189,248,0.25);
      cursor: pointer;
      border: none;
    }

    .viewer {
      position: relative;
      flex: 1;
      margin-top: 4px;
      border-radius: 14px;
      overflow: auto;
      background: radial-gradient(circle at top, #020617, #020617);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,1);
      padding: 16px;
      z-index: 1;
    }

    .viewer-inner {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100%;
      position: relative;
    }

    #pdfCanvas {
      background: #f9fafb;
      border-radius: 8px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.8);
      max-width: 100%;
      height: auto;
      cursor: crosshair;
    }

    #overlay {
      position: absolute;
      pointer-events: none;
    }

    #overlay .hint {
      position: absolute;
      right: 10px;
      bottom: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.92);
      color: var(--text-soft);
      font-size: 10px;
      box-shadow: 0 0 0 1px rgba(31,41,55,0.9);
      backdrop-filter: blur(8px);
    }

    .sidebar-body {
      margin-top: 4px;
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 4px 2px 2px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1;
    }

    .hint-block {
      padding: 10px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.1), rgba(15,23,42,0.9));
      box-shadow: inset 0 0 0 1px rgba(30,64,175,0.5);
      font-size: 11px;
      color: var(--text-soft);
    }

    .hint-block strong {
      color: #e0f2fe;
      font-weight: 500;
    }

    .status {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .status span {
      opacity: 0.9;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.3);
    }

    .status-dot.idle {
      background: #6b7280;
      box-shadow: 0 0 0 3px rgba(75,85,99,0.35);
    }

    .sig-preview {
      margin-top: 4px;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(148,163,184,0.5);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-soft);
      overflow: hidden;
    }

    .sig-preview img {
      max-width: 100%;
      max-height: 80px;
      display: block;
    }

    .shortcut-tag {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-soft);
    }

    .footer {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .footer a {
      color: #22d3ee;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Signature modal */
    #signature-modal {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    #signature-box {
      background: radial-gradient(circle at top left, rgba(15,23,42,1), rgba(17,24,39,1));
      padding: 16px;
      border-radius: 20px;
      box-shadow: 0 24px 60px rgba(15,23,42,1);
      border: 1px solid rgba(56,189,248,0.35);
      min-width: min(520px, 94vw);
    }

    #signature-box-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    #signature-box-header h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e0f2fe;
    }

    #signature-box-header span {
      font-size: 11px;
      color: var(--text-soft);
    }

    #signatureCanvas {
      width: 100%;
      height: 160px;
      border-radius: 12px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: repeating-linear-gradient(
        to bottom,
        rgba(15,23,42,0.98),
        rgba(15,23,42,0.98) 12px,
        rgba(15,23,42,0.9) 12px,
        rgba(15,23,42,0.9) 13px
      );
      box-shadow: inset 0 0 0 1px rgba(15,23,42,1);
      touch-action: none;
    }

    .sig-actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .btn.subtle {
      background: rgba(15,23,42,1);
      box-shadow: 0 0 0 1px rgba(55,65,81,0.9);
      color: var(--text-soft);
    }

    .btn.subtle:hover {
      background: rgba(15,23,42,1);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(148,163,184,0.7);
    }

    /* Floating page indicator */
    .page-indicator {
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.85);
    }
  </style>

  <!-- PDF.js core and worker -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js";
  </script>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="logo">
        <div class="logo-mark"></div>
        <div>
          <div class="logo-text-main">Fill &amp; Sign</div>
          <div class="logo-text-sub">Client-side PDF editor</div>
        </div>
      </div>
      <div class="header-actions">
        <span class="pill">All processing stays in your browser</span>
        <span class="shortcut-tag">Tip: Ctrl/Cmd + S to export</span>
      </div>
    </header>

    <main class="layout">
      <!-- Viewer panel -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Document</div>
            <div class="panel-subtitle">Open a PDF, annotate, sign &amp; save</div>
          </div>
          <div class="page-indicator">
            <span id="pageLabel">Page ‚Äì</span>
          </div>
        </div>

        <div class="toolbar">
          <div class="group">
            <label class="btn icon">
              <span>üìÇ</span>
              <span>Open</span>
              <input id="fileInput" type="file" accept="application/pdf" style="display:none;" />
            </label>
            <button id="savePdfBtn" class="btn icon" disabled>
              <span>üíæ</span>
              <span>Save</span>
            </button>
          </div>

          <div class="group">
            <button id="prevPageBtn" class="btn icon" disabled>‚¨Ö</button>
            <button id="nextPageBtn" class="btn icon" disabled>‚û°</button>
            <span class="btn" style="pointer-events:none;">
              <span id="pageInfo">Page ‚Äì / ‚Äì</span>
            </span>
          </div>

          <div class="group">
            <button id="zoomOutBtn" class="btn icon" disabled>‚ûñ</button>
            <button id="zoomInBtn" class="btn icon" disabled>‚ûï</button>
            <span class="btn" style="pointer-events:none;">
              <span id="zoomLabel">100%</span>
            </span>
          </div>

          <div class="group">
            <button id="toolSelectBtn" class="btn icon active">
              <span>üñ±</span><span>Select</span>
            </button>
            <button id="toolTextBtn" class="btn icon" disabled>
              <span>üÖ£</span><span>Text</span>
            </button>
            <button id="toolSignBtn" class="btn icon" disabled>
              <span>‚úíÔ∏è</span><span>Sign</span>
            </button>
          </div>
        </div>

        <div class="viewer" id="viewer">
          <div class="viewer-inner">
            <canvas id="pdfCanvas"></canvas>
            <div id="overlay"></div>
          </div>
        </div>
      </section>

      <!-- Sidebar panel -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Inspector</div>
            <div class="panel-subtitle" id="sidebarSub">No document loaded</div>
          </div>
          <div class="badge">
            <span class="status-dot idle" id="statusDot"></span>
            <span id="statusLabel">Idle</span>
          </div>
        </div>

        <div class="sidebar-body">
          <div class="hint-block">
            <strong>How to use</strong>
            <ul style="padding-left: 16px; margin: 4px 0 0; list-style: disc;">
              <li>Click <em>Open</em> to load a PDF from your device.</li>
              <li>Use <em>Text</em> mode to click anywhere and type.</li>
              <li>Use <em>Sign</em> to draw, then click the page to place your signature.</li>
              <li>Hit <em>Save</em> or press <code>Ctrl/Cmd + S</code> to export.</li>
            </ul>
          </div>

          <div>
            <div class="status">
              <span>Current tool</span>
              <span id="currentToolLabel">Select</span>
            </div>
          </div>

          <div>
            <div class="status">
              <span>Signature</span>
              <span id="signatureStatus">None captured</span>
            </div>
            <div class="sig-preview" id="sigPreview">
              <span>No signature yet</span>
            </div>
          </div>

          <div>
            <div class="status">
              <span>Document</span>
              <span id="docMeta">‚Äì</span>
            </div>
          </div>

          <div class="footer">
            <span>Everything runs in your browser: PDFs never leave this device.</span>
            <span style="opacity:0.8;">v1.0</span>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Signature modal -->
  <div id="signature-modal">
    <div id="signature-box">
      <div id="signature-box-header">
        <h2>Draw your signature</h2>
        <span>Use your mouse, trackpad, or finger</span>
      </div>
      <canvas id="signatureCanvas"></canvas>
      <div class="sig-actions">
        <button id="cancelSigBtn" class="btn subtle">Cancel</button>
        <button id="clearSigBtn" class="btn subtle">Clear</button>
        <button id="applySigBtn" class="btn primary">Use Signature</button>
      </div>
    </div>
  </div>

  <script>
    // DOM refs
    const fileInput = document.getElementById("fileInput");
    const pdfCanvas = document.getElementById("pdfCanvas");
    const overlay = document.getElementById("overlay");
    const viewer = document.getElementById("viewer");

    const savePdfBtn = document.getElementById("savePdfBtn");
    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");

    const toolSelectBtn = document.getElementById("toolSelectBtn");
    const toolTextBtn = document.getElementById("toolTextBtn");
    const toolSignBtn = document.getElementById("toolSignBtn");

    const pageInfo = document.getElementById("pageInfo");
    const zoomLabel = document.getElementById("zoomLabel");
    const pageLabel = document.getElementById("pageLabel");

    const sidebarSub = document.getElementById("sidebarSub");
    const statusDot = document.getElementById("statusDot");
    const statusLabel = document.getElementById("statusLabel");
    const currentToolLabel = document.getElementById("currentToolLabel");
    const signatureStatus = document.getElementById("signatureStatus");
    const sigPreview = document.getElementById("sigPreview");
    const docMeta = document.getElementById("docMeta");

    const sigModal = document.getElementById("signature-modal");
    const sigCanvas = document.getElementById("signatureCanvas");
    const clearSigBtn = document.getElementById("clearSigBtn");
    const cancelSigBtn = document.getElementById("cancelSigBtn");
    const applySigBtn = document.getElementById("applySigBtn");

    // State
    let pdfBytes = null;
    let pdfDoc = null;        // pdf-lib document
    let pdfjsDoc = null;      // PDF.js document
    let currentPage = 1;
    let totalPages = 0;
    let currentScale = 1.3;
    let signaturePad = null;
    let signatureDataUrl = null;
    let currentTool = "select"; // 'select' | 'text' | 'sign'
    let currentFileName = "";

    const MIN_ZOOM = 0.6;
    const MAX_ZOOM = 2.0;
    const ZOOM_STEP = 0.15;

    function setStatus(text, busy) {
      statusLabel.textContent = text;
      if (busy) {
        statusDot.classList.remove("idle");
      } else {
        statusDot.classList.add("idle");
      }
    }

    function setTool(tool) {
      currentTool = tool;
      currentToolLabel.textContent =
        tool === "select" ? "Select / Navigate" :
        tool === "text" ? "Text tool" :
        "Signature tool";

      [toolSelectBtn, toolTextBtn, toolSignBtn].forEach(btn => btn.classList.remove("active"));
      if (tool === "select") toolSelectBtn.classList.add("active");
      if (tool === "text") toolTextBtn.classList.add("active");
      if (tool === "sign") toolSignBtn.classList.add("active");
    }

    function updatePageUI() {
      pageInfo.textContent = totalPages
        ? "Page " + currentPage + " / " + totalPages
        : "Page ‚Äì / ‚Äì";
      pageLabel.textContent = totalPages
        ? "Page " + currentPage + " of " + totalPages
        : "Page ‚Äì";

      prevPageBtn.disabled = !pdfjsDoc || currentPage <= 1;
      nextPageBtn.disabled = !pdfjsDoc || currentPage >= totalPages;
    }

    function updateZoomUI() {
      zoomLabel.textContent = Math.round(currentScale * 100) + "%";
      zoomOutBtn.disabled = !pdfjsDoc || currentScale <= MIN_ZOOM + 0.01;
      zoomInBtn.disabled = !pdfjsDoc || currentScale >= MAX_ZOOM - 0.01;
    }

    function updateSignatureUI() {
      signatureStatus.textContent = signatureDataUrl ? "Captured" : "None captured";
      sigPreview.innerHTML = "";
      if (signatureDataUrl) {
        const img = document.createElement("img");
        img.src = signatureDataUrl;
        sigPreview.appendChild(img);
      } else {
        const span = document.createElement("span");
        span.textContent = "No signature yet";
        sigPreview.appendChild(span);
      }
    }

    function enableDocumentControls(enabled) {
      savePdfBtn.disabled = !enabled;
      prevPageBtn.disabled = !enabled || currentPage <= 1;
      nextPageBtn.disabled = !enabled || currentPage >= totalPages;
      zoomInBtn.disabled = !enabled;
      zoomOutBtn.disabled = !enabled;
      toolTextBtn.disabled = !enabled;
      toolSignBtn.disabled = !enabled;
    }

    async function renderPage(pageNumber) {
      if (!pdfjsDoc) return;
      setStatus("Rendering page " + pageNumber + "‚Ä¶", true);
      try {
        const page = await pdfjsDoc.getPage(pageNumber);
        const viewport = page.getViewport({ scale: currentScale });

        const ctx = pdfCanvas.getContext("2d");
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;

        const renderContext = {
          canvasContext: ctx,
          viewport,
        };

        overlay.style.width = viewport.width + "px";
        overlay.style.height = viewport.height + "px";
        overlay.style.left = pdfCanvas.offsetLeft + "px";
        overlay.style.top = pdfCanvas.offsetTop + "px";
        overlay.innerHTML = "";

        await page.render(renderContext).promise;

        // Hint bubble
        if (currentTool === "sign" || currentTool === "text") {
          const hint = document.createElement("div");
          hint.className = "hint";
          hint.textContent = currentTool === "sign"
            ? "Click anywhere on the page to place your signature"
            : "Click anywhere on the page to add text";
          overlay.appendChild(hint);
        }

        updatePageUI();
        updateZoomUI();
      } catch (err) {
        console.error(err);
        alert("Failed to render page: " + err.message);
      } finally {
        setStatus("Ready", false);
      }
    }

    function canvasClickToPdfCoords(event) {
      const rect = pdfCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const pdfX = x / currentScale;
      const pdfY = (pdfCanvas.height - y) / currentScale;
      return { pdfX, pdfY };
    }

    function downloadBytes(bytes, filename) {
      const blob = new Blob([bytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename || "edited.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function reloadPdfJsFromBytes() {
      if (!pdfBytes) return;
      pdfjsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
      totalPages = pdfjsDoc.numPages;
      if (currentPage > totalPages) currentPage = totalPages;
    }

    // ===== File loading =====
    document.querySelector("label[for='fileInput']")?.addEventListener("click", (e) => {
      e.preventDefault();
      fileInput.click();
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        setStatus("Loading PDF‚Ä¶", true);
        sidebarSub.textContent = "Loading " + file.name + "‚Ä¶";

        const buf = await file.arrayBuffer();
        pdfBytes = buf;
        currentFileName = file.name.replace(/\.pdf$/i, "") || "document";

        pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        pdfjsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        totalPages = pdfjsDoc.numPages;
        currentPage = 1;

        docMeta.textContent = totalPages + " page" + (totalPages !== 1 ? "s" : "");
        sidebarSub.textContent = "Loaded " + file.name;

        enableDocumentControls(true);
        setTool("select");
        signatureDataUrl = null;
        updateSignatureUI();
        currentScale = 1.3;
        await renderPage(currentPage);
      } catch (err) {
        console.error(err);
        alert("Failed to open PDF: " + err.message);
        setStatus("Error loading PDF", false);
        sidebarSub.textContent = "Error loading document";
      } finally {
        setStatus("Ready", false);
      }
    });

    // ===== Page navigation =====
    prevPageBtn.addEventListener("click", async () => {
      if (!pdfjsDoc || currentPage <= 1) return;
      currentPage--;
      await renderPage(currentPage);
    });

    nextPageBtn.addEventListener("click", async () => {
      if (!pdfjsDoc || currentPage >= totalPages) return;
      currentPage++;
      await renderPage(currentPage);
    });

    // ===== Zoom =====
    zoomOutBtn.addEventListener("click", async () => {
      if (!pdfjsDoc) return;
      currentScale = Math.max(MIN_ZOOM, currentScale - ZOOM_STEP);
      updateZoomUI();
      await renderPage(currentPage);
    });

    zoomInBtn.addEventListener("click", async () => {
      if (!pdfjsDoc) return;
      currentScale = Math.min(MAX_ZOOM, currentScale + ZOOM_STEP);
      updateZoomUI();
      await renderPage(currentPage);
    });

    // ===== Tools =====
    toolSelectBtn.addEventListener("click", () => setTool("select"));
    toolTextBtn.addEventListener("click", () => setTool("text"));
    toolSignBtn.addEventListener("click", () => setTool("sign"));

    // ===== Signature modal behaviour =====
    function openSignatureModal() {
      sigModal.style.display = "flex";
      if (!signaturePad) {
        signaturePad = new SignaturePad.default(sigCanvas);
      }
      // Resize canvas to actual CSS size
      const rect = sigCanvas.getBoundingClientRect();
      sigCanvas.width = rect.width * window.devicePixelRatio;
      sigCanvas.height = rect.height * window.devicePixelRatio;
      const ctx = sigCanvas.getContext("2d");
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      signaturePad.clear();
    }

    function closeSignatureModal() {
      sigModal.style.display = "none";
    }

    toolSignBtn.addEventListener("click", () => {
      if (!pdfDoc) return;
      setTool("sign");
      openSignatureModal();
    });

    clearSigBtn.addEventListener("click", () => {
      if (signaturePad) signaturePad.clear();
    });

    cancelSigBtn.addEventListener("click", () => {
      closeSignatureModal();
      if (!signatureDataUrl) setTool("select");
    });

    applySigBtn.addEventListener("click", () => {
      if (!signaturePad || signaturePad.isEmpty()) {
        alert("Please draw a signature first.");
        return;
      }
      signatureDataUrl = signaturePad.toDataURL("image/png");
      updateSignatureUI();
      closeSignatureModal();
      setTool("sign");
      alert("Signature captured. Click on the PDF page to place it.");
    });

    // Close modal on ESC
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && sigModal.style.display === "flex") {
        e.preventDefault();
        cancelSigBtn.click();
      }
    });

    // ===== Canvas interaction (text/signature placement) =====
    pdfCanvas.addEventListener("click", async (event) => {
      if (!pdfDoc) return;

      if (currentTool === "text") {
        const text = prompt("Text to insert:");
        if (!text) return;
        try {
          setStatus("Applying text‚Ä¶", true);
          const { pdfX, pdfY } = canvasClickToPdfCoords(event);
          const pages = pdfDoc.getPages();
          const page = pages[currentPage - 1];

          page.drawText(text, {
            x: pdfX,
            y: pdfY,
            size: 12,
            color: PDFLib.rgb(0, 0, 0),
          });

          const newBytes = await pdfDoc.save();
          pdfBytes = newBytes.buffer;
          await reloadPdfJsFromBytes();
          await renderPage(currentPage);
        } catch (err) {
          console.error(err);
          alert("Failed to add text: " + err.message);
        } finally {
          setStatus("Ready", false);
        }
      } else if (currentTool === "sign") {
        if (!signatureDataUrl) {
          alert("Capture a signature first (click the Sign tool).");
          return;
        }
        try {
          setStatus("Placing signature‚Ä¶", true);
          const { pdfX, pdfY } = canvasClickToPdfCoords(event);
          const pages = pdfDoc.getPages();
          const page = pages[currentPage - 1];

          const pngImage = await pdfDoc.embedPng(signatureDataUrl);
          const pngDims = pngImage.scale(0.25);

          page.drawImage(pngImage, {
            x: pdfX - pngDims.width / 2,
            y: pdfY - pngDims.height / 2,
            width: pngDims.width,
            height: pngDims.height,
          });

          const newBytes = await pdfDoc.save();
          pdfBytes = newBytes.buffer;
          await reloadPdfJsFromBytes();
          await renderPage(currentPage);
        } catch (err) {
          console.error(err);
          alert("Failed to place signature: " + err.message);
        } finally {
          setStatus("Ready", false);
        }
      } else {
        // Select / navigate tool: no-op for now
      }
    });

    // ===== Save PDF =====
    savePdfBtn.addEventListener("click", async () => {
      if (!pdfDoc) return;
      try {
        setStatus("Exporting PDF‚Ä¶", true);
        const bytes = await pdfDoc.save();
        downloadBytes(bytes, currentFileName + "_edited.pdf");
      } catch (err) {
        console.error(err);
        alert("Failed to save PDF: " + err.message);
      } finally {
        setStatus("Ready", false);
      }
    });

    // Ctrl/Cmd+S shortcut
    window.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
        e.preventDefault();
        if (!savePdfBtn.disabled) savePdfBtn.click();
      }
    });

    // Initial state
    setStatus("Idle", false);
    setTool("select");
    updateSignatureUI();
    updateZoomUI();
    updatePageUI();
  </script>
</body>
</html>
